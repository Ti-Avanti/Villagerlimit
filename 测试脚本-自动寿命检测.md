# 自动寿命检测功能测试脚本

## 测试环境准备

1. **服务器版本**：Minecraft 1.20+ (支持 Bukkit/Spigot/Paper)
2. **插件版本**：Villagerlimit-2.1.3.jar
3. **测试世界**：准备一个测试世界，包含多个村民

## 测试前配置

### config.yml 配置
```yaml
# 启用调试模式以查看详细日志
debug: true

villager-lifespan:
  enabled: true
  days: 7
  notify-enabled: true
  notify-range: 16
  
  # 自动添加寿命配置
  auto-add-lifespan:
    enabled: true
    check-interval: 300  # 5分钟检查一次
    check-on-startup: true  # 启动时检查
```

---

## 测试用例 1：启动时自动检测

### 目的
验证插件启动时能自动检测并添加寿命

### 步骤
1. 在测试世界中放置 5-10 个村民（使用刷怪蛋或命令）
2. 确保这些村民没有寿命（新放置的村民）
3. 重启服务器或重载插件
4. 等待 5 秒（启动延迟）

### 预期结果
- 控制台输出：`[寿命系统] 执行启动时自动检查...`
- 控制台输出：`[寿命系统] 自动检查完成 - 总村民数: X, 添加寿命: X, 已有寿命: 0`
- 所有村民头顶出现寿命显示文本（如：§e剩余 7天 0小时）

### 验证方法
```
/vllifespan check
```
应该显示：没有寿命的村民数量为 0

---

## 测试用例 2：定时任务自动检测

### 目的
验证定时任务能定期检测并添加寿命

### 步骤
1. 服务器已运行，自动检测功能已启用
2. 在游戏中使用刷怪蛋放置 3 个新村民
3. 等待 5 分钟（默认检查间隔）

### 预期结果
- 5分钟后控制台输出：`[寿命系统] 执行定时自动检查...`
- 控制台输出：`[寿命系统] 自动检查完成 - 总村民数: X, 添加寿命: 3, 已有寿命: X`
- 新放置的 3 个村民头顶出现寿命显示

### 验证方法
```
/vllifespan check
```
应该显示：没有寿命的村民数量为 0

---

## 测试用例 3：混合场景测试

### 目的
验证系统能正确区分有寿命和无寿命的村民

### 步骤
1. 使用命令手动为 5 个村民添加寿命：
   ```
   /vllifespan add 7
   ```
2. 使用刷怪蛋放置 5 个新村民（无寿命）
3. 等待定时任务执行或重启服务器

### 预期结果
- 控制台输出：`总村民数: 10, 添加寿命: 5, 已有寿命: 5`
- 只有新放置的 5 个村民被添加寿命
- 原有的 5 个村民寿命不变

---

## 测试用例 4：禁用自动检测

### 目的
验证配置开关能正确控制功能

### 步骤
1. 修改配置：
   ```yaml
   auto-add-lifespan:
     enabled: false
   ```
2. 重载配置：`/vlreload`
3. 放置新村民

### 预期结果
- 控制台输出：`[寿命系统] 自动添加寿命功能未启用`
- 新村民不会自动获得寿命
- 使用 `/vllifespan check` 能看到无寿命村民

---

## 测试用例 5：仅启动时检测

### 目的
验证可以配置为仅在启动时检测

### 步骤
1. 修改配置：
   ```yaml
   auto-add-lifespan:
     enabled: true
     check-interval: 0  # 0 表示不启用定时任务
     check-on-startup: true
   ```
2. 重载配置：`/vlreload`
3. 放置新村民
4. 等待 5 分钟

### 预期结果
- 控制台输出：`[寿命系统] 自动添加寿命任务仅在启动时执行`
- 5分钟后不会自动检测
- 重启服务器后才会检测新村民

---

## 测试用例 6：多世界测试

### 目的
验证能扫描所有世界的村民

### 步骤
1. 在主世界放置 5 个村民
2. 在下界放置 3 个村民（如果支持）
3. 在末地放置 2 个村民（如果支持）
4. 重启服务器或等待定时任务

### 预期结果
- 控制台输出：`总村民数: 10, 添加寿命: 10, 已有寿命: 0`
- 所有世界的村民都被检测到并添加寿命

---

## 测试用例 7：性能测试

### 目的
验证大量村民时的性能表现

### 步骤
1. 使用命令批量生成 50-100 个村民
2. 观察启动时检测的耗时
3. 观察定时任务的耗时

### 预期结果
- 检测过程不应导致服务器卡顿
- 日志正常输出统计信息
- 所有村民都被正确处理

---

## 测试用例 8：繁殖村民自动寿命

### 目的
验证繁殖的村民也能被自动检测系统处理

### 步骤
1. 禁用繁殖时自动添加寿命（修改代码或配置）
2. 让两个村民繁殖出小村民
3. 等待定时任务执行

### 预期结果
- 繁殖出的小村民被自动检测系统添加寿命
- 日志显示添加了寿命

---

## 调试技巧

### 查看详细日志
```yaml
debug: true
```

### 手动触发检测
重启服务器或使用：
```
/vlreload
```

### 检查村民状态
```
/vllifespan check  # 查看无寿命村民数量
/vllifespan list   # 查看无寿命村民位置
```

### 手动添加寿命
```
/vllifespan add 7  # 为所有无寿命村民添加7天寿命
```

---

## 常见问题排查

### 问题1：启动时没有自动检测
- 检查配置：`check-on-startup: true`
- 检查日志是否有错误信息
- 确认寿命系统已启用：`villager-lifespan.enabled: true`

### 问题2：定时任务不执行
- 检查配置：`check-interval` 不为 0
- 等待足够的时间（默认5分钟）
- 检查服务器是否正常运行

### 问题3：部分村民没有被检测到
- 确认村民所在区块已加载
- 检查是否是其他插件的假村民
- 查看调试日志确认扫描范围

---

## 测试完成检查清单

- [ ] 启动时自动检测正常工作
- [ ] 定时任务自动检测正常工作
- [ ] 能正确区分有寿命和无寿命村民
- [ ] 配置开关能正确控制功能
- [ ] 仅启动时检测模式正常工作
- [ ] 多世界扫描正常工作
- [ ] 大量村民时性能正常
- [ ] 繁殖村民能被正确处理
- [ ] 日志输出清晰准确
- [ ] 手动命令与自动检测配合正常

---

## 测试报告模板

```
测试日期：____年__月__日
测试人员：________
服务器版本：Minecraft ______
插件版本：Villagerlimit-2.1.3

测试结果：
- 测试用例1：[ ] 通过 [ ] 失败
- 测试用例2：[ ] 通过 [ ] 失败
- 测试用例3：[ ] 通过 [ ] 失败
- 测试用例4：[ ] 通过 [ ] 失败
- 测试用例5：[ ] 通过 [ ] 失败
- 测试用例6：[ ] 通过 [ ] 失败
- 测试用例7：[ ] 通过 [ ] 失败
- 测试用例8：[ ] 通过 [ ] 失败

问题记录：
1. _______________
2. _______________

建议：
1. _______________
2. _______________
```
